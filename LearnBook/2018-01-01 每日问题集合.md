### **每日问题集**

https://zhuanlan.zhihu.com/everyday-lin
https://medium.com/@nawarpianist/git-commit-best-practices-dab8d722de99


flask 查询数据有缓存 
查询前先 `db.session.commit()` 将当前 session 对象里的缓存提交（清空缓存），查询时就直接从数据库中查询最新数据。
https://www.cnblogs.com/huchong/p/9258458.html
https://www.jianshu.com/p/c0a8275cce99

## 2020-03-02

```
File "/usr/local/lib/python3.6/site-packages/pymysql/err.py", line 109, 
in raise_mysql_exception raise errorclass(errno, errval)
sqlalchemy.exc.InternalError: (pymysql.err.InternalError) 
(1267, "Illegal mix of collations (latin1_swedish_ci,IMPLICIT) 
and (utf8_general_ci,COERCIBLE) for operation '='")
```

错误原因是数据库字符集和表的字符集不匹配导致的。
 查看字符集方法：

```
show variables like "%char%";
show variables like "%coll%";
```

解决方法1：
修改数据库字符集修改为 utf8mb4 格式
 参考：
https://stackoverflow.com/a/1008336/10267639
https://stackoverflow.com/questions/32511288/illegal-mix-of-collations-utf8mb4-unicode-ci-explicit-and-utf8-general-ci-coe
https://blog.51cto.com/bian5399/1092772
 解决方法2:
 新建数据库时指定数据库字符集：

```
create database xxx default CHARACTER 
set utf8mb4 COLLATE utf8mb4_unicode_ci;
```



## 2020-02-25

pycharm 启动flask项目 默认启动都是`127.0.0.1:5000`(即使指定启动的ip、port)
解决方法：
在additional options中添加：—host=172.16.16.28 —port=6001
[Image: image.png]
## 2020-01-17 

### docker中日志查找

参考链接：https://stackoverflow.com/a/38207098/10267639

```
docker logs --since 1m -f container_id | grep "has no attribute"
```

### 日志输出再查找

参考链接：https://stackoverflow.com/a/37269320/10267639 

```
`docker logs nginx ``>`` stdout``.``log ``2``>``stderr``.``log`
`cat stdout``.``log ``|`` grep ``"has no attribute."`
```




### python f-string

参考链接：http://zetcode.com/python/fstring/
**格式化字符串大比拼：**str.format最慢，%s的稍快一点，F-string是最快的！
Python 3.6新增了f-strings，这个特性叫做`字面量格式化字符串`，F字符串是开头有一个f的字符串文字，Python会计算其中的用大括号包起来的表达式，并将计算后的值替换进去。


```
`In : name = 'lin'

In : f'Hello {name}'
Out: 'Hello Lin'

In : f'Hello {name.upper()}'
Out: 'Hello LIN'

In : d = {'id': 123, 'name': 'lin'}

In : f'User[{d["id"]}]: {d["lin"]}'
Out: 'User[123]: lin'`
```



## 2020-01-14 

openpyxl 去除默认的Sheet 
查询关键词： openpyxl remove  default Sheet 
参考链接：
https://stackoverflow.com/questions/46327467/openpyxl-not-removing-sheets-from-created-workbook-correctly
https://stackoverflow.com/a/51628232/10267639

```
`xlsx = Workbook()
xlsx.create_sheet('other name')
xlsx.remove(xlsx['Sheet'])
xlsx.save('some.xlsx')`
```

## 2020-01-13

获取数据库的当前时间

```
current_time = db.engine.execute('select NOW();').fetchone()
```

## 2020-01-09 

zip压缩太多的文件会导致部分文件损坏，建议只打包。

## 2020-01-08 

linux 文本中批量替换

```
# esc 
:%s/10.10/test.cn/
```



## git commit best practices 

https://stackoverflow.com/q/6543913/10267639
https://www.perforce.com/blog/vcs/git-commit-best-practices-streamline-development


## flask : how to architect the project with multiple apps?

https://stackoverflow.com/questions/15583671/flask-how-to-architect-the-project-with-multiple-apps
https://dev.to/paurakhsharma/flask-rest-api-part-2-better-structure-with-blueprint-and-flask-restful-2n93

flask中的blueprint 使用Response报错，但能正常返回数据

```
return Response((result, status_code,
        {'Content-Type': 'application/sse/json;charset=utf-8'})) # 多加了一个括号
        
# 导致错误 
Traceback (most recent call last):
  File "/Users/xiaoqinglin-guanliyuan/.local/share/virtualenvs/DataFlowTools-Yd81hy1s/lib/python3.7/site-packages/werkzeug/serving.py", line 302, in run_wsgi
    execute(self.server.app)
  File "/Users/xiaoqinglin-guanliyuan/.local/share/virtualenvs/DataFlowTools-Yd81hy1s/lib/python3.7/site-packages/werkzeug/serving.py", line 293, in execute
    write(data)
  File "/Users/xiaoqinglin-guanliyuan/.local/share/virtualenvs/DataFlowTools-Yd81hy1s/lib/python3.7/site-packages/werkzeug/serving.py", line 273, in write
    assert isinstance(data, bytes), "applications must write bytes"
AssertionError: applications must write bytes
```

参考链接：https://dev.to/paurakhsharma/flask-rest-api-part-2-better-structure-with-blueprint-and-flask-restful-2n93

```
***return****** ***Response(result, status_code, mimetype='application/json;charset=utf-8')
or 
***return ***Response(result, status=status_code, mimetype='application/json;charset=utf-8')
```




## 2020-01-07 

linux查看文件层级中文显示异常

```
tree -L 2 -N 
.
├── x3b_annu_2016_test
│   ├── [430002]2016年年度报告.txt
│   ├── [430003]2016年年度报告.txt
│   └── [430005]2016年年度报告.txt
└── x3b_ipo_test
    ├── [2008-06-17][430029]股份报价转让说明书.txt
    ├── [2008-08-27][430031]股份报价转让说明书.txt
    └── [2008-10-23][430033]股份报价转让说明书.txt
```

## 2020-01-03 

图数据库：
https://github.com/jbmusso/awesome-graph
https://awesomeopensource.com/projects/graph-database

解释一下ORM:
ORM（object-Relational Mapper ORM）：ORM是一个数据抽象层，描述存储在数据库中的表、行和列。
类：数据库中的表
属性：列
类的单个实例：数据库中的一行数据


## 2020-01-02

### re.escape(pattern)

转义pattern中的特殊字符。如果想对任意可能包含正则表达式元字符的文本字符串进行匹配。

```
print(re.escape('http://www.python.org'))
http://www\.python\.org 

operators = ['+', '-', '*', '/', '**'] 
print('|'.join(map(re.escape, sorted(operators, reverse=**True**))))
/|\-|\+|\*\*|\*
```



## 2020-01-01 

How to Install Chrome Driver on Mac (2019 Update)
参考链接：https://www.swtestacademy.com/install-chrome-driver-on-mac/


## 2019-12-27 

https://github.com/pypa/pipenv/issues/598
pipfile、pipfile.lock 是否需要添加到git管理


## 2019-12-24 

**AttributeError: dlsym(0xXXXXXXX, archive_read_support_filter_all): symbol not found** 
升级pycharm就可以了，不要浪费时间去找解决方案。

https://youtrack.jetbrains.com/issue/PY-39242?_ga=2.51641066.273994328.1577257370-1427562534.1537330810#focus=streamItem-27-3845736.0-0

如果要找解决方案，看下面（但都没有解决问题）：
https://stackoverflow.com/questions/34386527/symbol-not-found-pycodecinfo-getincrementaldecoder
https://ephrain.net/mac-%E5%9F%B7%E8%A1%8C-python-%E5%87%BA%E7%8F%BE-symbol-not-found-__pycodecinfo_getincrementaldecoder-%E9%8C%AF%E8%AA%A4/
https://stackoverflow.com/a/37745394


## 2019-12-22 

 **“'chromedriver' executable needs to be available in the path”**
参考链接：
https://stackoverflow.com/questions/29858752/error-message-chromedriver-executable-needs-to-be-available-in-the-path
https://chromedriver.storage.googleapis.com/index.html?path=80.0.3987.16/

```
`brew install chromedriver`
```

方法二：

```
`pip install webdriver-manager`
```

```
`from selenium import webdriverfrom webdriver_manager.chrome import ChromeDriverManager

driver = webdriver.Chrome(ChromeDriverManager().install())`
```

## 2019-11-06 peewee insert 

```
# MySQL supports upsert via the ON DUPLICATE KEY UPDATE clause. For example:

class User(Model):
    username = TextField(unique=True)
    last_login = DateTimeField(null=True)
    login_count = IntegerField()

# Insert a new user. 新建一个用户
User.create(username='huey', login_count=0)

# Simulate the user logging in. 
# The login count and timestamp will be either created or updated correctly.
now = datetime.now()
rowid = (User
         .insert(username='huey', last_login=now, login_count=1)
         .on_conflict(
             preserve=[User.last_login],  # Use the value we would have inserted.
             update={User.login_count: User.login_count + 1})
         .execute())
```



## 2019-10-29 

## Git-解释“Swap file .MERGE_MSG.swp already exists”的问题

参考：https://stackoverflow.com/questions/41284031/how-to-solve-git-merge-error-swap-file-merge-msg-swp-already-exists
操作步骤：

```
1、回到合并前状态
git merge -abort  // 中止合并
rm .git/.MERGE_MSG.sw* //删除 vim 非正常关闭产生的文件

2、重新合并
合并提交信息页面，使用 :wq! 或者 :q! 正常退出 VIM ，就能正常合并啦。

PS：
如果 .git/MERGE_* 文件中 只有 MERGE_MSG 文件的话，
不用执行 git merge -abort ,直接删除 .MERGE_MSG.sw* 文件就好


```

## 2019-09-10 

### Flask-SQLAlchemy 根据mysql数据库表反向生成 model的 py文件

数据表：

```
CREATE TABLE IF NOT EXISTS running (
    host VARCHAR(250), # 主机
    last_beat_time DATETIME,
);
```

安装包：

```
pip install flask-sqlacodegen 
```

执行命令参考：

```
`flask``-``sqlacodegen "mysql+pymysql://username:password@host/db_name"`` ``--``tables `
`table_name ``--``outfile ``"file_name"`` ``--``flask`
```

```
flask-sqlacodegen "mysql+pymysql://root:xiaoqinglin@127.0.0.1/db_demo"
--tables running --outfile "test1.py" --flask 
```

输出文件示例：

```
class RunningState(db.Model):
    __tablename__ = 'running'

    host = db.Column(db.String(250), primary_key=True, nullable=False)
    last_beat_time = db.Column(db.DateTime)
```

https://cloud.tencent.com/developer/article/1127765 model生成数据库表


## 2019-08-12

**问题1: 清空shell中的history 历史记录：** 

```
history -c 
```


**问题2:csv文件去除指定例为空的值后随机抽取**
pandas中两个dataframe做差集

```
import pandas as pd 

def random_select(json_path):
    df = pd.read_csv(json_path, encoding='utf-8')
    dn = df[df.审批意见.isnull() & df.前提条件.isnull() & df.管理条件.isnull() & df.非格式化审批内容.isnull()]
    df.append(dn)
    ds = df.drop_duplicates(subset=['审批意见', '前提条件', '管理条件', '非格式话审批书内容'], keep=False)
    random_df = ds.sample(frac=0.1)
    # 并未在原有df上排序，而是排序后返回
    sort_df = random_df.sort_values(by=['产品种类'], axis=0, ascending=False)
    sort_df.to_csv('sample_0830.csv', index=False)    
```

## **2019-08-28**

从win本地移动文件到docker指定的目录中 ，中文文件名乱码。
分析问题出现的原因：

1. 检查shell命令行是否可以输入正文；
2. 检查代码中的中文是否能正常显示。

若1、2都没有问题，则原因为：
由于zip格式中并没有指定编码格式，Windows下生成的zip文件中的编码是GBK/GB2312等，因此，导致这些zip文件在Linux下解压时出现乱码问题，因为Linux下的默认编码是UTF8。目前网上流传一种unzip -O cp936的方法，但一些unzip是没有-O这个选项的。

解决方法：

1. zip  压缩文件
2. 上传压缩文件至服务器
3. 解压文件：unzip -O cp936 demo.zip



## 2019-08-27 

咔咔咔，无处不在的编码问题
https://www.codeleading.com/article/64661585737/

### 读取csv文件报错：

https://stackoverflow.com/questions/22216076/unicodedecodeerror-utf8-codec-cant-decode-byte-0xa5-in-position-0-invalid-s

```
 UnicodeDecodeError: 'utf8' codec can't decode byte 0xa5 in position 0: 
 invalid start byte (https://stackoverflow.com/questions/22216076
 /unicodedecodeerror-utf8-codec-cant-decode-byte-0xa5-in-position-0-invalid-s)
```

```
def random_select(json_path):
    df = pd.read_csv(json_path, encoding='gb18030') # 权宜之计
    random_df = df.sample(frac=0.1)
    # 并未在原有df上排序，而是排序后返回
    sort_df = random_df.sort_values(by=["产品种类"], axis=0, ascending=False) 
    sort_df.to_csv('choice_0108.csv', index=False) # index=False,不写入索引
    
***if****** ***__name__ == "__main__":
    choice_cols('path')
```

## 2019-08-21 

### windows中文件路径问题（这win真不是好惹的主，太🥚痛了）：

若文件路径中含有类似格式：

```
%Y-%m-%d_%H:%M:%S
```

### 写入文件报错： “Python OSError: [Errno 22] Invalid argument...”

OMG修改一下：

```
%Y_%m_%d_%H_%M_%S
```

### win conda 源码安装包

下载所需要的包：https://anaconda.org/conda-forge/repo?sort=time.modified&sort_order=asc&page=14&label=gcc7

```
将` ...tar.bz2` 的文件放到：`c:ProgramData\Anaconda3\pkgs`
```

[Tinge Zhang](https://hujialou.quip.com/ZNPAEAwKHdp)

打开cmd，conda不是内部命令, 配置环境变量 

我的电脑-属性-高级系统设置-高级-环境变量-系统变量-Path-编辑
添加

```
C:\ProgramData\Anaconda3\Scripts
```

```
cd C:\ProgramData\Anaconda3\pkgs
```

```
`conda install --`use`-`local`  ...tar.bz2 `
```

## 2019-08-20 

解决xshell终端中文显示乱码

```
export `LC_ALL=zh_CN.utf-8 `
```

解决xftp显示中文乱码

```
File ---> properties ---> Options ---> **勾选 Use UTF-8 encoding**
```

* * *

```
心好累：
从此不论是用啥（pandas、open）读取文件、写入文件，都主动加上（**encoding****=****'utf-8'**）。
运行任何命令：凡是有文件路径都使用绝对路径。
任何软件编码一律：utf-8 
```

## 2019-08-12 

参考链接：https://stackoverflow.com/a/53356077/10267639

```
error: each element of 'ext_modules' option must be an Extension instance or
 2-tuple
```

修改：
I had to reorder import statements to get rid of this error. This code generates the error:

```
`from Cython.Build import cythonize
from setuptools import find_packages, setup`
```

This code does not generate the error:

```
`from setuptools import find_packages, setup
from Cython.Build import cythonize`
```




## 2019-06-20 

问题1: 
原生正则表达式 为什么不匹配单词(两个字符)？

```
eg:  [^(北京)]*  -->错误理解：不匹配 "北京" 这个单词，但可匹配 北海 北平
                -->正确理解：只要出现  “北” 或 “京” 的句子都不匹配。
                . 是匹配任意字符，而[^]是不匹配某个字符，
                .*
                [^]*
```

## 2019-06-19

问题1:(估计还会再用到的)

### 适配 会议届次 的正则

```
re.compile('(?P<meeting_num>第[一二三四五六七八九十]届.{0,15}第?[一二三四五六七八九十]{1,3}?次(.{0,8}?会议)?(（临时会议）)?)'),
re.compile('(?P<meeting_num>第?[一二三四五六七八九十]届.{0,15}第?[一二三四五六七八九十]{1,3}?次(.{0,8}?会议)?(（临时会议）)?)'),
re.compile('(?P<meeting_num>\d{4}年(?!(\d{1,2}月)).*?第(\d{1,2}|[一二三四五六七八九十]{1,3})次(.{0,8}?会议)?(（临时会议）)?)'),
re.compile('(?P<meeting_num>第?[一二三四五六七八九十]届.*?第\d{1,3}次(.{0,8}?会议)?(（临时会议）)?)'),
re.compile('(?P<meeting_num>第\d届.*?第\d{1,3}次(.{0,8}?会议)?)(（临时会议）)?'),
```

### 适配 会议时间 的正则

```
re.compile("(?P<date>\d{4}年\d{1,2}月.{1,8}?日(?:[上下]午.{0,5})?(?:\d{1,2}[:：]\d{1,2})?)(?:(?:召开|举行)|在((?!发出)[^；。，]){2,50}?(?:召开|举行)|以((?!发出)[^；。，]){2,50}?方式(?:召开|举行))"),
re.compile(
"(?P<date>\d{4}年\d{1,2}月.{1,8}?日(?:[上下]午.{0,5})?(?:（星期[一二三四五六日]）)?(?:\d{1,2}[:：]\d{1,2})?)((?!发出)[^；。，]){1,20}?(?:(?:召开|举行)|在[^。；，]{2,50}?(?:召开|举行)|以[^。；，]{2,50}?方式(?:召开|举行))"),
re.compile("(?P<date>\d{4}年\d{1,2}月.{1,8}?日)[^；。]{0,30}?(?:董事会)[^；。]{0,30}?(?:举行)"),
re.compile(
"(?P<date>[零O○〇一二三四五六七八九十]{4}年[零O○〇一二三四五六七八九十]{1,2}月[零O○〇一二三四五六七八九十]{1,3}日)[^；。]{0,30}?(?:[^发出了](?:召开|举行)|在[^。；]{2,30}?(?:召开|举行)|以[^。；]{2,30}?方式(?:召开|举行))"),
re.compile("^(?P<date>\d{4}年\d{1,2}月.{1,8}?日)[^；。]{0,40}?(?:召开|举行)"),
# 2019 年 1 月 29 日以现场+通讯方式召开
re.compile('(?P<date>\d{4}年\d{1,2}月.{1,8}?日)[^，]*?以(现场+通讯方式|现场结合通讯表决方式)召开'),
# 2018年6月22日，会议以通讯表决方式召开
# 召开时间：2018年1月17日
re.compile("决议表决截止日为(?P<date>\d{4}年\d{1,2}月\d{1,2}日)"),
re.compile('(召开|会议)时间[：:](?P<date>\d{4}年\d{1,2}月.{1,8}?日(?:[上下]午)?(?:\d{1,2}[:：]\d{1,2})?)'),
re.compile("并于.*?(?P<date>\d{4}年\d{1,2}月.{1,8}?日).{1,10}?通过会议决议"),
re.compile(
".*?通知.{1,30}?，.{1,30}?(?P<date>(\d{4}年)?\d{1,2}月.{1,8}?日(?:[上下]午)?(?:\d{1,2}[:：]\d{1,2})?).*?(现场)?召开"),
re.compile(
".*?通知.{1,30}?，.{1,30}?(?P<date>(\d{4}年)?\d{1,2}月.{1,8}?日(?:[上下]午)?(?:\d{1,2}[:：]\d{1,2})?).*?(?:召开|举行)"),
re.compile("(?P<date>\d{4}年\d{1,2}月.{1,8}?日).*?会议室"),
re.compile("会议于.*?(?P<date>\d{4}年\d{1,2}月.{1,8}?日).*?(现场)?召开"),
re.compile("(?P<date>\d{4}年\d{1,2}月.{1,8}?日).*?(?:召开|举行)"),
re.compile("于(?P<date>\d{1,2}月.{1,8}?日).*?通讯(表决)?方式召开"),
re.compile("会议于.*?(?P<date>\d{4}年\d{1,2}月\d).*?(现场)?召开"),
re.compile("会议表决截止时间为(?P<date>\d{4}年\d{1,2}月.{1,8}?日)"),
```



## 2019-06-18

问题1:

```
# 使用 上下文管理器 时，一定加上字符编码，不然各种坑呢
with open('xxx.xxx', 'w', encoding='utf-8') as f: 
    pass  
```




## 2019-5-19 

### 正则中常用的前后查找操作符

|操作符	|说明	|
|---	|---	|
|(?=)	|正向前查找	|
|(?!)	|负向前查找	|
|(?<=)	|正向后查找	|
|(?<!)	|负向后查找	|

## 2019-5-15

### 问题1

pathlib的使用
https://docs.python.org/3/library/pathlib.html

```
str(pathlib.Path(__file__).resolve().parents[2])
```



## 2019-5-14

### 问题1: 

mysql 中数据入库发生错误： ` 1264    Out of range value for column 'xxxxx' at row 864`

### 问题原因：

### 字段的值超过其可输入的范围了，比如：int(10)，但导入的数据中有超出此范围

### 解决方法：

把字段的类型改一下，eg: 修改为bigint(50)


### 问题2:

字符串转为decimal
参考链接：https://stackoverflow.com/questions/4643991/python-converting-string-into-decimal-number

```
`from decimal import Decimal

price = "1098,965.0000"
price_in_decimal = Decimal(price.replace(',',''))`
```

### 问题3：

时间计算
参考链接：https://dateutil.readthedocs.io/en/stable/relativedelta.html 好用

```
# 安装 pip install python-dateutil
from datetime import date 
***from ***dateutil.relativedelta ***import ***relativedelta

# 是years 不是year 
>>> date.today() + relativedelta(years=-2, months=+1)
datetime.date(2017, 6, 15)
```




## 2019-05-13

匹配任意字符（包括换行符在内的任意字符）

```
[\s\S]*
```



## 2019-05-07 

## 问题1：

虽然在pycharm中配置了提取需要的相关模板（提取文件、测试文件、pattern文件、case文件夹），但都要到指定的目录下新建，有点麻烦

### 解决想法：

1、运行脚本，在相应的文件夹下生成相应的模板文件

## 问题2:

两个list，求并集、交集、差集  

```
lis1 = []
lis2 = []

# 并集
res_1 = set(lis1) | set(lis2)

# 交集
res_2 = set(lis1) & set(lis2)

# 差集
res_3 = set(lis1) - set(lis2)

#  (也可用difference、union、intersection，但...)
```

## 问题3

### mac 多进程运行报错

```
"""
objc[89654]: +[__NSPlaceholderDictionary initialize] may have been in progress in another thread when fork() was called.
objc[89654]: +[__NSPlaceholderDictionary initialize] may have been in progress in another thread when fork() was called.
 We cannot safely call it or ignore it in the fork() child process. Crashing instead. Set a breakpoint on objc_initializeAfterForkError to debug.
"""
```

解决方法：
参考链接：https://github.com/rtomayko/shotgun/issues/69
添加：
`OBJC_DISABLE_INITIALIZE_FORK_SAFETY=YES`
[Image: image.png]

## 2019-05-06

 使用peewee,当需要查询数据表中某条数据是否存在时，推荐使用：

```
Food.select(Food.id).where(Food.uuid == uuid) # 查询时间：1s
```

不推荐使用：

```
# 如果数据存在，它会将该条数据的所有字段信息都会加载，数据量很大时，非常耗时、耗资源
Food.select().where(Food.uuid == uuid)  # 查询时间：3s
```

注：

1. 我们需要什么，就获取什么
2. 只单写以上两句并不会执行查询操作（当遇到 for、if等才会去数据库中查询）

## 2019-04-07 字符串相似度比较 

`from difflib import SequenceMatcher`
`def similarity(a, b):`
`     return SequenceMatcher(None, a, b).ratio()`



## 2019-03-28

### python mac 启用多进程报错解决办法

参考链接：
https://www.jianshu.com/p/e62e17c137cb
https://stackoverflow.com/questions/50168647/multiprocessing-causes-python-to-crash-and-gives-an-error-may-have-been-in-progr

错误信息：

```
`objc[27880]: +[__NSPlaceholderDate initialize] may have been in progress in another thread when fork() was called
`may have been in progress in another thread when fork() was called``
```

解决方法1:
OBJC_DISABLE_INITIALIZE_FORK_SAFETY=YES
[Image: WechatIMG194.jpeg]
解决方法2:
terminal 

```
`cd ~
sudo vim .bash_profile`
```

在最后一行添加：

```
`export OBJC_DISABLE_INITIALIZE_FORK_SAFETY=YES`
```



## 2019-02-25

### 感谢龙哥🎉

净资产评估价值 = 总资产评估价值 - 总负债评估价值
增值率 = （净资产评估价值 - 净资产账面价值）/ 净资产账面价值


## 2019-02-19

### 感谢龙哥🎉

### 股权转让的付款方式是什么？

链接：http://www.64365.com/zs/751591.aspx
因此，按照有关规定，股权转让的付款方式有三种，可以以现金、资产支付，也可以用其他股权支付。 


## 2019-02-15

git中搜索

### 从当前目录的所有文件中查找文本内容：

```
`$ git grep "sum"`
```

### 在某一版本中搜索文本：

```
`$ git grep "Hello" v1.0`
```

## 2019-02-01

## 问题1

提取字段中存在    “为”作谓词

`?<!     和    ?!`  参考 [2019-01-20 正则表达式](https://hujialou.quip.com/dRdmA74Lasnr)

```
REGEX_SNIPS = {
    # '为'作谓词    
    'wei': '(?<![，：较将更作视都互成分])为(?![准例主])',
    }
re.compile('供应商(%(wei)s)(?P<supplier>.*)' % REGEX_SNIPS)
```



## 2019-01-29

## 问题1

感谢龙哥的解答

参考链接：https://wiki.mbalib.com/wiki/%E8%82%A1%E7%A5%A8%E6%8A%95%E8%B5%84%E6%94%B6%E7%9B%8A

## 什么是股票投资收益？

 股票投资收益是指[企业](https://wiki.mbalib.com/wiki/%E4%BC%81%E4%B8%9A)以购买股票的形式[对外投资](https://wiki.mbalib.com/wiki/%E5%AF%B9%E5%A4%96%E6%8A%95%E8%B5%84)取得的[股利](https://wiki.mbalib.com/wiki/%E8%82%A1%E5%88%A9)，转让、出售股票取得款项高于股票帐面[实际成本](https://wiki.mbalib.com/wiki/%E5%AE%9E%E9%99%85%E6%88%90%E6%9C%AC)的差额，[股权投资](https://wiki.mbalib.com/wiki/%E8%82%A1%E6%9D%83%E6%8A%95%E8%B5%84)在被投资单位增加的[净资产](https://wiki.mbalib.com/wiki/%E5%87%80%E8%B5%84%E4%BA%A7)中所拥有的数额等。

## 问题2

## 证券代码区分

6：沪主板
0：深主板、中小板
3：深创业板



## 2019-01-23 

## 问题1

## 正则表达式中的正/反向预查

### 1、正向预查

1. (?:pattern) 匹配结果。**python(?:6|7)**等效于**Java6|Java7**，结果**python6** **python**7
2. (?=pattern) 正向匹配。**python****(?=6)**，匹配后面跟着6的**python**，即第一个**python**，结果**python**6 **python**7
3. (?!pattern) 正向不匹配。**python****(?!6)**，匹配后面不跟着6的**python**，即第二个**python**，结果**python**6 **python**7

### 2、反向预查

1. (?<=pattern) 反向匹配。**(?<=J)a**，匹配紧跟字母J后面的a，结果Java6 Java7
2. (?<!pattern) 反向不匹配。**(?<!J)a**，不匹配紧跟字母J后面的a，结果Java6 Java7



## 2019-01-17

## 问题1

## 递归下载一个目录下的所有文件

感谢爽哥

```
wget -r -np -nH -R index.html http://url/including/files/you/want/to/download/
各个参数的含义：
-r : 遍历所有子目录
-np : 不到上一层子目录去
-nH : 不要将文件保存到主机名文件夹
-R index.html : 不下载 index.html 文件
```



## 2019-01-15 

## 问题1

### git statsh时--->fatal: git-write-tree: error building trees

参考链接：
https://stackoverflow.com/questions/5483213/fatal-git-write-tree-error-building-trees
https://stackoverflow.com/a/16056225/10267639

解决方法：

```
git reset --mixed
instead of git reset --hard. You will not lose any changes.
```

[Image: image.png]
## 问题2

### Django中复制/克隆一个模型的实例(Copying model instances[¶](https://docs.djangoproject.com/en/2.1/topics/db/queries/#copying-model-instances))

参考链接：https://docs.djangoproject.com/en/2.1/topics/db/queries/#copying-model-instances

```
blog = Blog(name='lin', company='memect')
blog.save() # blog.pk = 1 

blog.pk = None
blog.save() # blog.pk = 2
```



## 2019-01-14 

### `<_sre.SRE_Match object; span=(0, 3), match='abc'>`对象，span指的是匹配到的字符在字符串中的位置下标，分别对应start和end

eg:

```
for para_num, para in enumerate(paragraphs):
    match = None 
    for prefix in cls._detail_patterns:
        match = prefix.search(para)
        if match:
            break 
    if match:
        if metch.end() == len(para):
            if para_ix + 1 < len(paragraphs)：# 判断当前匹配的位置是否是最后一段
                detail = paragraphs[para_ix] 
        else:
            # 否则当前段落的剩余部分是描述
            detail = para[match.end():]
            is_match_in_para = True 
        # 找到目标，跳出循环
        break
```





## 2019-01-12

## groupdict() 返回一个字典，包含所有命名的匹配子组，键值是子组名。

```
>>> m = re.match(r'(?P<user>\w+)@(?P<comp>\w+)\.(?P<extension>\w+)','xql@me.com')
>>> m.groupdict()
{'comp': 'lin', 'user': 'xql', 'extension': 'com'}
```



## reversed（）不改变原对象;只在第一次遍历时返回值

```
l=[1,2,3,4,5]
res =reversed(l)
l
[1, 2, 3, 4, 5]
res
<listreverseiterator object at 0x06A9E930>
for i in res:#第一次遍历
...     print(i),
... 
5 4 3 2 1
```

## 2019-01-10 

## super()

未整理
MRO 就是类的方法解析顺序表, 其实也就是继承父类方法时的顺序表。

```
class FooParent(object):
    def __init__(self):
        self.parent = 'I\'m the parent.'
        print ('Parent')
    
    def bar(self,message):
        print ("%s from Parent" % message)
 
class FooChild(FooParent):
    def __init__(self):
        # super(FooChild,self) 首先找到 FooChild 的父类（就是类 FooParent），然后把类B的对象 FooChild 转换为类 FooParent 的对象
        super(FooChild,self).__init__()    
        print ('Child')
        
    def bar(self,message):
        super(FooChild, self).bar(message)
        print ('Child bar fuction')
        print (self.parent)
 
if __name__ == '__main__':
    fooChild = FooChild()
    fooChild.bar('HelloWorld')
```



## 2019-01-08

## 问题1:

参考链接：https://dba.stackexchange.com/questions/75214/postgresql-not-running-on-mac

### PostgreSQL not running on Mac 

```
`$ brew services stop postgresql
$ rm /usr/local/var/postgres/postmaster.pid # adjust path accordingly to your install
$ brew services start postgresql`
```


[Image: image.png]PostgresSQL的主进程是Postmaster，当启动PostgresSQL后，会在PostgreSQL中的数据文件夹下生产一个`postmaster.pid`的文件。
postmaster.pid的内容：https://blog.csdn.net/xzwspy/article/details/80724944

## 问题2

## os.path 、[os.work](http://os.work/) 

```
__file__： 当前文件所在路径

# 获取当前文件的绝对路径
os.path.realpath(__file__)
 
# 返回当前文件的绝对路径,相当于 os.path.split(path)的第一个元素 
os.path.dirname(os.path.realpath(__file__))
```

```
>>> os.path.dirname(os.path.realpath(os.getcwd()))
'/Users/xiaoqinglin-guanliyuan/PycharmProjects/company_project'

>>> os.path.split(os.getcwd())
('/Users/xiaoqinglin-guanliyuan/PycharmProjects/company_project', 'MemectExtractor')

```

**os.walk(top, topdown=True, onerror=None, followlinks=False)**

递归方式自顶向下或者自底向上的方式遍历目录树，对每一个目录都返回一个三元元组(dirpath, dirnames, filenames)。

**三元元组(dirpath, dirnames, filenames)**

1. dirpath - 遍历所在目录树的位置，是一个字符串对象
2. dirnames - 目录树中的子目录组成的列表，不包括("."和"..")
3. filenames - 目录树中的文件组成的列表

```
>>> type(os.walk('/Users/xiaoqinglin-guanliyuan/PycharmProjects/company_project/MemectExtractor/extractors/template'))
<class 'generator'> # 返回一个生成器对象
```

## 

## 2019-01-07

## 分支替换

参考链接：
https://gitlab.com/zbjdonald/personal-wiki/blob/master/Git.md
https://stackoverflow.com/a/2862606/10267639
https://github.com/LeachZhou/blog/issues/11
[https://gitbook.tw/chapters/](https://gitbook.tw/chapters/github/using-force-push.html)
[hub/using-force-push.html](https://gitbook.tw/chapters/github/using-force-push.html)

将developer分支用master分之完全替换

```
`git branch -m developer old-developer
git branch -m master developer 
git push -f origin developer 
# remote: GitLab: You are not allowed to force push code to a protected branch on this project.
# To http://git.xxx.cn/xxx/xxx
#  ! [remote rejected] master -> master (pre-receive hook declined)
# error: failed to push some refs to 'http://xxx@git.xxx.cn/xxx/xxx.git'`
```


**gitlab → settings  →Repository → Protected Branches**

[Image: image.png]受保护的分支不允许进行强制推送，解除掉受保护的分支即可，UnProtect解除保护，然后再次进行强制推送命令
`$ git push origin developer -f`。
推完之后再回到这里进行重新保护master分支，选择分支，点击Protect即可
[Image: image.png]

## 2019-01-04

## 问题1

## Datagrip中运行sql语句

[Image: image.png]
### ORM生成的sql语句：

```
SELECT "exports_exports"."fold_amount" 
FROM "exports_exports" 
WHERE (("exports_exports"."cargo_unit_name" = 斯柏化工(上海)有限公司 OR "exports_exports"."business_unit_name" = 斯柏化工(上海)有限公司) AND "exports_exports"."export_date" 
BETWEEN 2018-01-01 AND 2018-12-31)
 ORDER BY "exports_exports"."export_date" DESC
```

## 问题2

## django ORM中filter的坑

### 参考链接：

http://www.liujiangblog.com/course/django/129
https://docs.djangoproject.com/zh-hans/2.1/topics/db/queries/#chaining-filters

```
# and的关系
Users.objects.filter(name=name1, date=date1) 
```

和

```
# or的关系
Users.objects.filter(name=name1).filter(date=date1) 
```

## 问题2

## 对queryset进行排序

```
[<TechnicalRegistration: TechnicalRegistration object (PD20142644)>,
<TechnicalRegistration: TechnicalRegistration object (PD20141369)>]
```

```
from operator import attrgetter
sorted(querylist, key=attrgetter("**id**")
```



## 2019-01-02

## 问题1

## django中批量删除redis数据库中的缓存数据

```
from django_redis import get_redis_connection
>>> conn = get_redis_connection('foreground_exports_detail')
```

```
# 获取所有的缓存数据的key
for i in conn.keys("*"):
...     print(i.decode('utf-8'))
```

```
# 删除缓存数据
for i in conn.keys("**_**year**_export"):*
*...     print(conn.delete(i))** *
*1*
*1*
*1*
```

## 问题2 

## 发送验证码、更新密码等接口的权限设置

设置完成以后，在代码里需`验证邮箱(serializers---> ***validate_email***)`是否已经注册，注册则发送验证码,否则不发送

```
class ...Viewset(mixins.CreateModelMixin, viewsets.GenericViewSet):
    permission_classes = (AllowAny,)
    
    
```



## 2019-01-01

## 问题1 

## django orm list to queryset 

参考链接：https://stackoverflow.com/a/4790371/10267639

```
exports_query = Exports.objects.filter(pk__in=[x.pk ***for ***x ***in ***export_objs])
```



## 问题2

## 正则表达式匹配

```
`# 只需提取匹配百分数
re.findall(r'(\d{0,2}(\.\d{1,2})?%)', '中国90%的城市80.5%')`
`[('90%', ''), ('80.5%', '.5')]`
```

修改

```
>>> re.findall(r'(\d{0,2}(?:\.\d{1,2})?%)', '中国90%的城市80.5%')
['90%', '80.5%']
```

[Image: image.png]

## 2018-10-10

## **问题1: **

### **How to remove items from a list while iterating?**

参考链接：
https://stackoverflow.com/questions/1207406/how-to-remove-items-from-a-list-while-iterating
https://stackoverflow.com/a/1208792
列表中含有字典：

```
somelist[:] = [x for x in somelist if not determine(x)]
somelist[:] = [x for x in somelist if determine(x)]
```



## **问题2: **

### **How to check if any value is NaN in a Pandas DataFrame**

### **Use None instead of np.nan for null values in pandas DataFrame**

参考链接：
https://stackoverflow.com/questions/29530232/how-to-check-if-any-value-is-nan-in-a-pandas-dataframe
https://stackoverflow.com/questions/39279824/use-none-instead-of-np-nan-for-null-values-in-pandas-dataframe
http://pandas.pydata.org/pandas-docs/stable/generated/pandas.DataFrame.where.html

```
df.where(df.notnull(), None)
```



## **问题3:**

### **Filtering against query parameters**

参考链接：
https://www.django-rest-framework.org/api-guide/filtering/#filtering-against-query-parameters

参考链接：

```
class CustomsList(generics.ListAPIView):
    serializer_class = CustomsSerializer

    def get_queryset(self):
        queryset = Customs.objects.all()
        name = self.request.query_params.get('name', None)
        if username is not None:
            queryset = queryset.filter(technical__name=name)
        return queryset
# 搜索链接 （注：最后不能添加“/”）
http://example.com/api/customs/?name="草甘膦" 
```



## 问题4: 

### **How to get the parent dir location **

### **os.path 获取**

问题搜索关键字： python file path Parent 
https://simpleisbetterthancomplex.com/tutorial/2018/08/27/how-to-create-custom-django-management-commands.html
[How to get the parent dir location](https://stackoverflow.com/questions/2817264/how-to-get-the-parent-dir-location)
[Get parent of current directory from Python script](https://stackoverflow.com/questions/30218802/get-parent-of-current-directory-from-python-script)
os.path.join 将多个路径组合后返回，第一个绝对路径之前的参数将被忽略
os.path.dirname 返回path的目录。其实就是`os.path.split(path)`的第一个元素

```
path = os.path.join(os.path.dirname(__file__), os.path.join('templates', 'blog1/page.html'))
aParent
   |--a
   |  |---b.py
   |      |---templates
   |              |--------blog1
   |                         |-------page.html
   |--templates
          |--------blog1
                     |-------page.html
```


how to get the a Parent location:

```
dirname = os.path.dirname 
path = os.path.join(dirname(dirname(__file__)), os.path.join('templated', 'blog1/page.html'))
```


or

```
path = os.path.abspath(os.path.join(os.path.dirname(__file__), ".."))
import os
current_dir =  os.path.abspath(os.path.dirname(__file__))
parent_dir = os.path.abspath(current_dir + "/../")
path = os.path.abspath(os.path.join(os.path.dirname(os.path.abspath(__file__)),"..",".."))
```




## **2018-10-11 **

## 问题1:

### 获取被关联模型中的一个对象


搜索关键词：to_representation override 
参考链接：
https://stackoverflow.com/a/31821891/10267639

### **https://www.django-rest-framework.org/api-guide/serializers/#creating-new-base-classes**

github上的example:
https://github.com/manueljrr/mafia/blob/8cfb83c896574e7cd869302802f294c22c510b52/app/serializers.py

```
def to_representation(self, instance):
    data = super(IntermediateListSerializer, self).to_representation(instance)
    interdiateprice = instance.intermediateprice.all().first()
    data['price'] = interdiateprice.price
    data['date'] = interdiateprice.date
    return data
```



## 问题2:

### 通过API返回一个excel模板文件


搜索关键字：
参考链接：
https://xlsxwriter.readthedocs.io/working_with_pandas.html
https://stackoverflow.com/a/50686105/10267639

```
def get(self, request):
    df = pd.DataFrame({"时间": [], "中间体名称": [], "当期价格": [], "实物/折百": []})
    excel_file = BytesIO()
    writer = pd.ExcelWriter(excel_file, engine='xlsxwriter')
    df.to_excel(writer, sheet_name="Sheet1", na_rep=None, startcol=-1)
    writer.save()
    writer.close()
    excel_file.seek(0)
    response = HttpResponse(excel_file.read(),
                            content_type='application/vnd.ms-excel')
    response['Content-Disposition'] = 'attachment; filename="Intermediate.xlsx"'
    return response
```



## 问题3:

### 设置导出excel文件的样式


搜索关键词：pandas xlsxwriter excel set_row

参考链接：
https://xlsxwriter.readthedocs.io/worksheet.html

常用格式：

* 字体颜色：color
* 字体加粗：bold
* 字体大小：font_site
* 日期格式：num_format
* 超链接：url
* 下划线设置：underline
* 单元格颜色：bg_color
* 边框：border
* 对齐方式：align

```

        workbook = writer.book
        font_fmt = workbook.add_format({'font_name': 'Arial', 'font_size': 18, 'align': 'center'})
        header_fmt = workbook.add_format({'font_name': 'Arial', 'font_size': 18, 'bold': True, 'align': 'center'})
        # 设置A-Z的列宽
        worksheet.set_column('A:D', 30, font_fmt)
        # 设置1-20行的行高
        for i in range(1, 21):
            worksheet.set_row(i, 30, font_fmt)
```



## 2018-10-15

## 问题1:

### django scripts run 配置

1.新建一个package的包scripts 
[Image: Image.jpg]

2.配置运行环境
[Image: Image.jpg]

## 问题2:

### migrations.py和model不对应

[Image: image.png]
## 2018-10-16

## 问题1:

### 数据库中的数据，如果数据已经存在则更新，不存在则创建


搜索关键词： djagno update_or_create
参考链接：https://docs.djangoproject.com/zh-hans/2.1/ref/models/querysets/#update-or-create 

```
# 代码实现
defaults = {'first_name': 'Bob'}
try:
    obj = Person.objects.get(first_name='John', last_name='Lennon')
    for key, value in defaults.items():
        setattr(obj, key, value)
    obj.save()
except Person.DoesNotExist:
    new_values = {'first_name': 'John', 'last_name': 'Lennon'}
    new_values.update(defaults)
    obj = Person(**new_values)
    obj.save()
```

上面的方法随着模型中字段数量的增加，这种模式变得相当笨拙
使用 `**`update_or_create()`**` 进行简化:

```
obj, created = Person.objects.update_or_create(first_name='John', 
            last_name='Lennon',defaults={'first_name': 'Bob'},)
```



## 问题2:

### datetime <=> date

datetime -> date

```

>>> **import** _datetime
_>>> datetime.now().date()
datetime.date(2018, 1**0**, 16)
```


date -> datetime

```

>>> datetime.date.today()
datetime.date(2018, 10, 16)
>>> today = datetime.date.today()
>>> datetime.datetime.combine(today, datetime.time())
datetime.datetime(2018, 10, 16, 0, 0)
>>> datetime.datetime.combine(today, datetime.time.min)
datetime.datetime(2018, 10, 16, 0, 0)
```



## 问题3:

### 需要嵌套返回数据，且当前需要序列化的model中没有外键

```
class LessonSerializer(serializers.ModelSerializer):
    
    exercises = serializers.SerializerMethodField()

    class Meta:
        model = Lesson
        fields = '__all__'

    def get_exercises(self, obj):
        qs = obj.exercises.all().order_by('index')
        return ExerciseSerializer(qs, many=True, read_only=True).data
```

## 2018-10-17 

## 问题1：

### 自动生成django model的关联关系图


参考链接：
https://bytes.vokal.io/20151026-graphing-django-models/
https://django-extensions.readthedocs.io/en/latest/graph_models.html

settings.py 文件配置：
`pipenv intall django-extensions pygraphviz`

```
`INSTALLED_APPS = (
    'django_extensions',
    ...
)

GRAPH_MODELS = {
    'pygraphviz': **True**,
    'group_models': **True**,
    'exclude_models': 'BasePasscode, AbstractBaseUser, PermissionsMixin, Group, Permission'
}`
```


`$ ./manage.py graph_models -o db_graph.png app_name1 app_name2 app_name3 app_name4 `

mac安装 pygraphviz不能安装上:
错误信息：
[Image: Image.jpg]解决方法：
参考链接：https://graphviz.gitlab.io/download/
`brew install graphviz
brew install graphviz-devel
pipenv install pygraphviz --dev`

[Image: Image.jpg][Image: Image.jpg]

## 问题2:

### 将已经commit的文件改为Untrack file 


查询关键词：git change a commit file untracked

参考链接：https://kimsereyblog.blogspot.com/2016/09/untrack-file-previously-pushed-with-git.html

```
`(qiaochang-ZI9x__ny) ➜ qiaochang git:(feature/intermediate_model) ✗ git ls-tree -r developer
100644 blob 4b9b114a72c1d8d14d0e0c22200952ef18cf2fa0 .env.example 
100644 blob 17058d3d0f62fd17f3a555efdd7dfb30e8f771d1 .gitignore 
100644 blob 32070de6135ce85702269302125d229105eff42f Pipfile
100644 blob 92efd471225f264e353a4b8e30d818a14632298b Pipfile.lock

(qiaochang-ZI9x__ny) ➜  qiaochang git:(feature/`intermediate_model`) ✗ git rm --cached qiaochang/users/migrations/0001_initial.py 
rm 'qiaochang/users/migrations/0001_initial.py'

(qiaochang-ZI9x__ny) ➜  qiaochang git:(feature/`intermediate_model`) ✗ git rm --cached qiaochang/exports/migrations/0001_initial.py 
rm 'qiaochang/exports/migrations/0001_initial.py'

(qiaochang-ZI9x__ny) ➜  qiaochang git:(feature/`intermediate_model`) ✗ git commit -m "remove exports/migrations/0001_initial.py users`/migrations/0001_initial.py`"
[feature/change_intermediate_technical_model 4f149f4] remove users、exports 0001——initial.py
 2 files changed, 140 deletions(-)
 delete mode 100644 qiaochang/exports/migrations/0001_initial.py
 delete mode 100644 qiaochang/users/migrations/0001_initial.py

(qiaochang-ZI9x__ny) ➜  qiaochang git:(feature/`intermediate_model`) ✗ git push 
Enter passphrase for key '/Users/xiaoqinglin-guanliyuan/.ssh/id_rsa': 
Enumerating objects: 9, done.
Counting objects: 100% (9/9), done.
Delta compression using up to 8 threads.
Compressing objects: 100% (5/5), done.
Writing objects: 100% (5/5), 487 bytes | 487.00 KiB/s, done.`
```

## 2018-10-18

## 问题1：

### django+pandas 生成的excel文件名为中文


查询关键字：django download file name chinese

参考链接：https://stackoverflow.com/questions/9531067/downloading-a-file-with-chinese-characters-in-the-name-in-django-with-httprespon

```
`Chrome浏览器，采用**Base64编码或ISO编码的中文输出
**FireFox浏览器，采用**Base64或filename*或ISO编码的中文输出**`
```



```
***from ***django.utils.encoding ***import ***escape_uri_path
def upload_template_excel(header, file_name):
    """excel上传模板"""
    df = pd.DataFrame(columns=header)
    excel_file = BytesIO()
    writer = pd.ExcelWriter(excel_file, engine='xlsxwriter')
    df.to_excel(writer, sheet_name="Sheet1", na_rep=None, startcol=-1)
    response = HttpResponse(excel_file.read(), content_type='application/vnd.ms-excel')
    # 需要进行
    response['Content-Disposition'] = "attachment; filename*=utf-8''{}".format(escape_uri_path(file_name))
    return response
```


**`escape_uri_path`(*path*)[**[source]**](https://docs.djangoproject.com/en/2.1/_modules/django/utils/encoding/#escape_uri_path)**

Escapes the unsafe characters from the path portion of a Uniform Resource Identifier (URI).

## 问题2:

将整数转为excel的列字母：

### 

查询关键词：excel numbers to columns python

参考链接：https://stackoverflow.com/questions/23861680/convert-spreadsheet-number-to-column-letter

```
def col_range(max_col_num, start_col_label="A"):
    """
    生成columns("A:AB")
    :param max_col_num:最大列数字
    :param start_col_label: 起始列数字
    :return: "A:Z" or "A:AA"
    """
    col_letter = num_to_col_label(max_col_num)
    return "{start}:{end}".format(start=start_col_label, end=col_letter)

def num_to_col_letters(num):
    """
    将数字转为excel中的最大列字母
    1-> A
    27 -> AA
    """
    letters = ''
    while num:
        mod = (num - 1) % 26
        letters += chr(mod + 65)
        num = (num - 1) // 26
    return ''.join(reversed(letters))


```

将列字母转为数字：
参考链接：http://pythonfiddle.com/leetcode171-excel-sheet-column-number/

```
class Solution():
    def col_letters_to_num(self, s):
        """
        :type s: str
        :rtype: int
        """
        s = s.upper()
        LETTERS = "ABCDEFGHIJKLMNOPQRSTUVWXYZ"
        maps = {}
        for i in range(26):
            maps[LETTERS[i]] = i+ 1
            
        col = 0 
        for l in s:
            col = 26*col + maps[l]
        
        return col
```

## 2018-10-19 

## 问题1:

### APIView与GenericAPIView的区别


参看链接：
[Rewriting our API using class-based views](https://www.django-rest-framework.org/tutorial/3-class-based-views/#rewriting-our-api-using-class-based-views)
APIView:https://www.django-rest-framework.org/api-guide/views/
GenericApiView:https://www.django-rest-framework.org/api-guide/generic-views/#genericapiview

APIView:
APIView是django中View的子类:
使用APIView时，接收的请求会被dispatch到对应的方法中，如`get()、``post() 、put()、patch()、delete()`
[Image: Image.jpg]

```
# eg:
class SnippetList(APIView):

    # 处理GET请求,调用了drf本身的serializer以及Response方法
    def get(self, request, format=None):
        snippet = Snippet.objects.all()
        serializer = SnippetSerializer(snippet, many=True)
        return Response(serializer.data)
```

GenericView:
GenericView扩展了REST framework的APIView类，adding commonly required behavior for` standard list and detail views(重点)`

Attributes:
[Image: Image.jpg]
```
from rest_framework import generics

class CourseListView(generics.GenericAPIView):
    """
     用户列表页
    """
    queryset = User.objects.all()
    serialize_class = User.Serializer

    def get(self, request, *args, **kwargs):
        pass 
```

## 2018-10-24 

## 问题1：

### django中使用MD5判断文件内容是否相同


参考链接：
https://stackoverflow.com/questions/16874598/how-do-i-calculate-the-md5-checksum-of-a-file-in-python
https://stackoverflow.com/questions/1072569/see-if-two-files-have-the-same-content-in-python/1072576#1072576
https://stackoverflow.com/questions/3431825/generating-an-md5-checksum-of-a-file


```
import hashlib
class GeneralImportView(APIView):

 def post(self, request):
 import_file = request.FILES['file']
 file_name = import_file.name
 upload_month = file_name.split(".")[0]
 md5_returned = cmp_hash(import_file, upload_month)


def cmp_hash(file_obj, upload_moth):
 hash1 = hashlib.md5()
 # file_obj.read() django中存在的方法
 hash1.update(file_obj.read())
 md5_returned = hash1.hexdigest()

 customs_querys = CustomsRawData.objects.filter(date=upload_moth)
 if customs_querys:
 customs_data = customs_querys.first()
 if hash1 == customs_data.hash:
 return None
 else:
 return md5_returned
```

## 2018-10-28 

## 问题1:

### 删除excel表格中全为nan的行

### 删除excel表中全为的nan行


查询关键词：pandas remove rows with all nan
参考链接：
https://stackoverflow.com/a/27579343/10267639
https://pandas.pydata.org/pandas-docs/stable/generated/pandas.DataFrame.dropna.html

```
df.dropna(how="all")
```

采用位置进行选择 `iloc`, 连续选或者跨行选等操作。

```
df.iloc[start:end]
```



```
`print(df.iloc[3,1])
# 13
print(df.iloc[3:5,1:3])
             B   C
2013-01-04  13  14
2013-01-05  17  18
print(df.iloc[[1,3,5],1:3])
             B   C
2013-01-02   5   6
2013-01-04  13  14
2013-01-06  21  22`
```


插入列：
https://pandas.pydata.org/pandas-docs/stable/generated/pandas.DataFrame.insert.html

```
df.insert(loc=6, column=6, value=date)
```


多个df合并成一个新的df:
df_list = [df1, df2, df3]

```
data_frame = pd.concat(df_list)
```



## 2018-10-29

## 问题1: 

### 删除nan的行后， 重置索引


搜索关键词：
pandas reset index
pandas handle index lost
http://pandas.pydata.org/pandas-docs/version/0.16/indexing.html
https://stackoverflow.com/questions/40755680/how-to-reset-index-pandas-dataframe-after-dropna-pandas-dataframe

```
`df = df.dropna(how='any')
df = df.reset_index(drop=True)`
```



## 问题2:

### pathlib的使用：

https://docs.python.org/3/library/pathlib.html
https://xin053.github.io/2016/07/03/pathlib%E8%B7%AF%E5%BE%84%E5%BA%93%E4%BD%BF%E7%94%A8%E8%AF%A6%E8%A7%A3/


## 2018-10-30 

## 问题3:

### Using python dictionaries rather than Redis for some use cases?

参考链接：https://forums.manning.com/posts/list/30936.page

### 定时任务schedule

https://github.com/dbader/schedule
https://schedule.readthedocs.io/en/stable/

```
import schedule
import time


def job():
    print('I am working')


schedule.every(10).minutes.do(job)
schedule.every(3).seconds.do(job)
schedule.every().hour.do(job)
schedule.every().day.at('11:30').do(job)
schedule.every().monday.do(job)
schedule.every().wednesday.at("13:15").do(job)

while True:
    schedule.run_pending()
    time.sleep(1)
```

```
/Users/xiaoqinglin-guanliyuan/.local/share/virtualenvs/qiaochang-ZI9x__ny/bin/python /Users/xiaoqinglin-guanliyuan/PycharmProjects/qiaochang/qiaochang/technical/scripts/schedule_demo.py
I am working
I am working
I am working
I am working
I am working
I am working
I am working
```


http://docs.python-requests.org/zh_CN/latest/user/quickstart.html

## 2018-11-1 

## 问题1：

### django orm  values_list的使用，flat参数 

https://docs.djangoproject.com/en/2.1/ref/models/querysets/#values-list
[Image: image.png]
## 问题2:

### 用户自定义认证：

https://docs.djangoproject.com/en/2.1/ref/settings/
https://docs.djangoproject.com/zh-hans/2.1/topics/auth/customizing/


## 问题3:

### django 支持数据库服务


https://docs.djangoproject.com/zh-hans/2.1/topics/db/transactions/#controlling-transactions-explicitly

```
**from** **django.db** **import** transaction

@transaction.atomic**
def** viewfunc(request):
*# This code executes inside a transaction.*do_stuff()
```



## 问题4:

### 使用 Requests 发送网络请求非常简单



```
>>> **import** requests
>>> payload = {'key1': 'value1', 'key2': 'value2'}
>>> r = requests.get("http://httpbin.org/get", params=payload)
>>> print(r.url)
http://httpbin.org/get?key1=value1&key2=value2&key2=value3
>>> r.json()
[{u'repository': {u'open_issues': 0, u'url': 'https://github.com/...
```



## 2018-11-04 

## 问题1:

### git中的Fast Forward模式：

合并分支时，Git会用`Fast forward`模式，但该模式下，删除分支后，会丢掉分支信息。
如果要强制禁用`Fast forward`模式，Git就会在merge时生成一个新的commit，这样，从分支历史上就可以看出分支信息。

`使用--no-ff`方式强制禁用Fast Forward模式

```
`git merge --no-ff -m "add Car model" feature/add_Car_model`
```


合并分支时，加上`--no-ff`参数就可以用普通模式合并，合并后的历史有分支，能看出来曾经做过的合并，而`fast forward`合并就看不出来曾经做过合并。

## 2018-11-05 

## 问题1:

### python中如何表示正负无穷

```
float("inf") # 正无穷
float("-inf") # 负无穷
```



## 2018-11-06

## 问题1： 

### 字符串转时间

```
import datetime 
def str_to_date(str_date):
    """字符串转日期"""
    date_obj = datetime.strptime(str_date, '%Y%m%d').date()
    return date_obj
```

## 2018-11-07 

## 问题1:

### 使用request，发送post请求

```
payload_dict = {'key1': ['value1', 'value2']}
>>> r2 = requests.post('[https://0.0.0.0:8000/post](https://httpbin.org/post)', data=payload_dict)
```

## 2018-11-08

## 问题1:

### 查询关键字： python nested dict check value 

参考链接：https://stackoverflow.com/questions/25833613/python-safe-method-to-get-value-of-nested-dictionary
itertools参考链接：

```
try:
    example_dict['key1']['key2']
except KeyError:
    pass
```

```
`key2_value = (example_dict.get('key1') or {}).get('key2')`
```



## 问题2:

### django 中对queryset中的值求和计算（对查询集进行聚合运算）


参考链接：https://docs.djangoproject.com/zh-hans/2.1/topics/db/aggregation/

```
**>>> ****from** **django.db.models** **import** Avg, Count, Min, Sum
**>>> Technical**.objects.annotate(Sum('fold_amount'))
```



## 2018-11-12

## 问题1：

### 如何通过日期计算是第几周


查询关键词：how to get  week number in python

参考链接：http://week-number.net/programming/week-number-in-python.html

```
`**from** datetime **import** date

weekNumber **=** date**.**today**(****)****.**isocalendar**(****)****[****1****]****print** **'Week number:'****,** weekNumber`

```




## 2018-11-13 

## 问题1:

### 对时间查询集按年月进行分组


itertool模块参考链接：http://www.wklken.me/posts/2013/08/20/python-extra-itertools.html

## groupby

`groupby` 用于对序列进行分组，它的使用形式如下：

```
`from itertools import groupby
groupby(iterable,[ keyfunc])`
```


使用之前一定要对iterable进行排序
其中，iterable 是一个可迭代对象，keyfunc 是分组函数，用于对 iterable 的**连续项**进行分组，如果不指定，则默认对 iterable 中的连续相同项进行分组，返回一个 `(key, sub-iterator)` 的迭代器。
此函数返回的迭代器生成元素(key, group)，其中key是分组的键值，group是迭代器，生成组成该组的所有项

## 问题2：

### 获取日期列表中最大的日期


参考链接：
https://stackoverflow.com/a/3922666/10267639
https://docs.djangoproject.com/en/2.1/topics/db/queries/

```
from datetime import datetime

datetime_list = [
    datetime(2009, 10, 12, 10, 10),
    datetime(2010, 10, 12, 10, 10),
    datetime(2010, 10, 12, 10, 10),
    datetime(2011, 10, 12, 10, 10), #future
    datetime(2012, 10, 12, 10, 10), #future
]

print(max(datetime_list))
```

multiple times 
django orm multiple times

## 问题3：

### django postgres中ArrayField的使用


查询链接：
https://django-postgres-extensions.readthedocs.io/en/latest/arrays.html

```
rom django.db import modelsfrom django_postgres_extensions.models.fields 
import ArrayField
class Product(models.Model):
    tags = ArrayField(models.CharField(max_length=15), null=True, blank=True)
    moretags = ArrayField(models.CharField(max_length=15), null=True, blank=True)
```



## 问题4：

### django postgres ArrayField set default

[Image: image.png]参考链接：`**`ArrayField`**`
https://docs.djangoproject.com/zh-hans/2.1/ref/contrib/postgres/fields/#arrayfield

[Image: image.png]
## 2018-11-14

passphrase: n 密码
populate: 填充

## 问题1 

### django 中通过判断一个日期是否在一个日期区间内过滤数据


查询关键词： django orm date range

参考链接：https://docs.djangoproject.com/zh-hans/2.1/ref/models/querysets/#range

### `**`range`**`

```
**import** **datetime
**start_date = datetime.date(2005, 1, 1)
end_date = datetime.date(2005, 3, 31)
Entry.objects.filter(pub_date__range=(start_date, end_date))
```


SQL equivalent:
` WHERE ``pub_date ``BETWEEN ``'2005-01-01' **`and`** ``'2005-03-31'``;`
You can use `**`range`**` anywhere you can use `**`BETWEEN`**` in SQL — for dates, numbers and even characters.
**警告**

Filtering a `**`DateTimeField`**` with dates won't include items on the last day, because the bounds are interpreted as "0am on the given date". If `**`pub_date`**` was a `**`DateTimeField`**`, the above expression（表示） would be turned into this SQL:

## SELECT

`WHERE` `pub_date` `BETWEEN` `'2005-01-01 00:00:00'` **`and`** `'2005-03-31 00:00:00'``;`
Generally speaking, you can't mix dates and datetimes.


## 2018-11-15

## 问题1:

### 使用serializer.Serializer进行create() or update()操作是否需要 return instance ?

### 需要，序列化完成之后，调用save()方法，save()方法中会检查instance是否存在


**参考源码：**

```
 def dispatch(instance, import_type, serializer, row_result):
        if import_type == RowResult.IMPORT_TYPE_NEW:
            serializer.save()
            row_result.import_type = RowResult.IMPORT_TYPE_NEW
        elif import_type == RowResult.IMPORT_TYPE_UPDATE:
            serializer.instance = instance
            serializer.save()
            row_result.import_type = RowResult.IMPORT_TYPE_UPDATE
        elif import_type == RowResult.IMPORT_TYPE_SKIP:
            row_result.import_type = RowResult.IMPORT_TYPE_SKIP
        elif import_type == RowResult.IMPORT_TYPE_DELETE:
            instance.delete()
            row_result.import_type = RowResult.IMPORT_TYPE_DELETE
        else:
            # todo raise 无法识别的 import_type Error
            pass
        return row_result
```

## serializer.save()

[Image: image.png]
## 问题2:

### [Return nested serializer in serializer method field](https://stackoverflow.com/questions/33945148/return-nested-serializer-in-serializer-method-field)

### [SerializerMethodField](https://www.django-rest-framework.org/api-guide/fields/#serializermethodfield) 使用方法

This is a `read-only field.` It gets its value by calling a method on the serializer class it is attached to. It can be used to add any sort of data to the serialized representation of your object.

**Signature**: `SerializerMethodField(method_name=None)`

* `method_name` - The name of the method on the serializer to be called. If not included this defaults to `get_<field_name>`.
* The serializer method referred to by the `method_name` argument should accept a single argument (in addition to `self`), which is the object being serialized. It should return whatever you want to be included in the serialized representation of the object. For example:

```
from django.contrib.auth.models import User
from django.utils.timezone import now
from rest_framework import serializers

class UserSerializer(serializers.ModelSerializer):
    intermediate_price = serializers.SerializerMethodField()
    intermediate_capacity = serializers.SerializerMethodField()
    
    class Meta:
        model = Intermediate
        fields = ("intermediate_price", "intermediate_capacity")

    def get_intermediate_price(self, obj):
        """获取中间体的价格"""
        prices = obj.intermediateprice.all()
        return IntermediatePriceSerializer(prices, many=True, read_only=True).data

    def get_intermediate_capacity(self, obj):
        """获取中间体的产能数据"""
        # 获取该中间体的所有生产企业
        capacity = obj.intermediatecapacity.all()
        return IntermediateCapacitySerializer(capacity, many=True, read_only=True).data
```

**eg:**
[Image: image.png]
## 2018-11-16 

### How to Create Group By Queries With Django ORM

https://simpleisbetterthancomplex.com/tutorial/2016/12/06/how-to-create-group-by-queries.html

## 2018-11-20 

当前日期计算上一个月的日期

```
`>>> import datetime 
>>> import dateutil.relativedelta
>>> date = datetime.datetime.now().date()
>>> last_month_date =  date + dateutil.relativedelta.relativedelta(months=-1)`
```



## 2018-11-21

[Image: image.png]
## 问题2:

https://chase-seibert.github.io/blog/2012/02/24/django-aggregation-group-by-day.html

### Django aggregation, group by day

## 2018-11-22

## 问题1

### python program search

https://www.programcreek.com/python/index/module/list

## 问题2

### django rest framework cache 

https://github.com/Onyo/django-rest-framework-cache
http://ses4j.github.io/2015/11/23/optimizing-slow-django-rest-framework-performance/

## 问题3

https://www.dabapps.com/blog/api-performance-profiling-django-rest-framework/
http://blog.oneapm.com/apm-tech/304.html

## 问题4

### DJANGO - DATABASE ACCESS OPTIMIZATION

https://micropyramid.com/blog/django-database-access-optimization/


### BUILDING HIGH PERFORMANCE DJANGO SYSTEMS

https://impythonist.wordpress.com/2016/02/21/building-high-performance-django-systems/

## 问题5

### debug-toolbar的使用

https://www.chenshaowen.com/blog/django-debug-toolbar.html

## 2018-11-25

## 问题1

### python当中的魔法方法

https://pycoders-weekly-chinese.readthedocs.io/en/latest/issue6/a-guide-to-pythons-magic-methods.html

## 2018-11-26

## 问题1

### GMT时间转为Datetime

1、将datetime类型转换成HTTP头所用的GMT时间格式字符串

```
import datetime
GMT_FORMAT = '%a, %d %b %Y %H:%M:%S GMT'
datetime.datetime.utcnow().strftime(GMT_FORMAT)
```

2、再看下如何将GMT时间格式的字符串转换成datetime类型：

```
TIME = '[2018-11-28 06](tel:2018050806):17:00'
datetime.datetime.strptime(TIME,GMT_FORMAT)
```

3、GMT时间与我国本地时间有个时间差，如果要转换成本地时间，需要再加减一段时间

```
datetime.datetime.strptime(TIME,GMT_FORMAT)+datetime.timedelta(hours=8) #这样就转换成了我国的时间了，北京时间是东八区，要加上8个小时
```

## 问题2

### “2018年11月26日” 转为Date

```
>>> from datetime import datetime 
>>> date = datetime.strptime(“2018年2月3日”, “%Y年%M月%d日”).date()
# 输出结果：
>>> datetime.date(2018, 2, 3)
```

## 问题3

### 常用代码块：

https://github.com/Skycrab/code/blob/acd7590f566fb02a713eb4ab7d8c0be0b32f3b1a/Python/bi/eye_util.py

## 2018-11-27

## 问题1

### xmind-sdk-python 

https://pypi.org/project/xmind-sdk/

## 问题2 

### ManytoManyField 在 django rest 序列化嵌套使用时所需参数

## [ManyToManyFields with a Through Model](https://www.django-rest-framework.org/api-guide/relations/#manytomanyfields-with-a-through-model)

By default, relational fields that target a `ManyToManyField` with a `through` model specified are set to read-only.
If you explicitly specify a relational field pointing to a `ManyToManyField` with a through model, be sure to set `read_only` to `True`.

**Arguments**:

* `many` - If applied to a to-many relationship, you should set this argument to `True`.

eg：

```
news = NewsSerializer(many=True, read_only=True)
```

## 问题3 

### zipfile.ZipFile是否可以接收file_object

```
*class* **`zipfile.``ZipFile`(*file*, *mode='r'*, *compression=ZIP_STORED*, *allowZip64=True*, *compresslevel=None*)：
    pass
```

### 参考链接：

https://docs.python.org/3/library/zipfile.html
https://docs.python.org/3/library/zipfile.html#zipfile-objects

### `源码查看：`

[Image: image.png]
## 问题4

### 扩展包在PyPI上发布

http://www.wbh-doc.com.s3.amazonaws.com/Python-OpenSource-Project-Developer-Guide/Chapter2%20-%20PyPI.html
https://segmentfault.com/a/1190000008663126


## 2018-11-28

## 问题1 

### PostgreSQL 中ArrayField的查找

查询关键词：Django Postgres ArrayField lookup

参考链接：https://docs.djangoproject.com/zh-hans/2.1/ref/contrib/postgres/fields/

### contains

```
**>>> **Post.objects.create(name='First post', tags=['thoughts', 'django'])
**>>> **Post.objects.create(name='Second post', tags=['thoughts'])
**>>> **Post.objects.create(name='Third post', tags=['tutorial', 'django'])
**>>> **Post.objects.filter(tags__contains=['thoughts']) # 是列表，不是字符串
<QuerySet [<Post: First post>, <Post: Second post>]
>**>>> **Post.objects.filter(tags__contains=['django'])
<QuerySet [<Post: First post>, <Post: Third post>]>
```



### contained_by

```
>>> Post.objects.create(name='First post', tags=['thoughts', 'django'])
>>> Post.objects.create(name='Second post', tags=['thoughts'])
>>> Post.objects.create(name='Third post', tags=['tutorial', 'django'])
>>> Post.objects.filter(tags__contained_by=['thoughts', 'django'])
<QuerySet [<Post: First post>, <Post: Second post>]>
>>> Post.objects.filter(tags__contained_by=['thoughts', 'django', 'tutorial'])
<QuerySet [<Post: First post>, <Post: Second post>, <Post: Third post>]>
```

## 2018-11-29

## 问题1 

## Basic Usage

https://docs.python.org/3/library/json.html#basic-usage

```
json.dumps(obj, skipkeys=False, ensure_ascii=True, check_circular=True, 
allow_nan=True, cls=None, indent=None, separators=None, encoding="utf-8",
default=None, sort_keys=False, **kw)
```

## 问题2

## Fluent python → tuple += 

```
>>> t = (1,2 ,[30, 40])
>>> t[2] += [50, 60] # t[2]被改动也抛出异常
Traceback (most recent call last):
File "<stdin>", line 1, in <module>
TypeError: 'tuple' object does not support item assignment
>>> t
(1, 2, [30, 40, 50, 60])

# 修改代码
>>> t = (1,2 ,[30, 40])
>>> t[2].extend([50, 60])
>>> t
(1, 2, [30, 40, 50, 60])
```

总结：

1. 不要把可变对象放在元组里面
2. 增量赋值不是一个原子操作

## 2018-11-30

## 问题1

## ManytoMany →  Relation sets can be cleared

参考链接：https://docs.djangoproject.com/zh-hans/2.1/topics/db/examples/many_to_many/

```
**# 反向操作
>>> **p2.article_set.clear()
**>>> **p2.article_set.all()
<QuerySet []>
```


And you can clear from the other end:

```
# 正向操作
>>> a4.publications.all()
<QuerySet [<Publication: Science News>, <Publication: Science Weekly>]>
>>> a4.publications.clear()
>>> a4.publications.all()
<QuerySet []>
>>> p2.article_set.all()
<QuerySet [<Article: Oxygen-free diet works wonders>]>
```

## 2018-12-1

## 问题1

## pipenv graph fails: No module named 'pipenv' 

**查询关键词：ImportError: cannot import name 'get_installed_distributions'**
**参考链接：https://github.com/pypa/pipenv/issues/2952**
**错误信息：**
[Image: image.png]**解决方法：**

```
pip install pipenv
pipenv run pip install pip==18.0
pipenv install
```



## 2018-12-3

## 问题1

## networkx 和 pygraphviz生成图

参考链接：https://stackoverflow.com/a/22214653/10267639

```
import networkx as nx
import pygraphviz as pgv # pygraphviz should be available
G = nx.DiGraph([(dic[0], dic[2]) for dic in dics])
A = nx.nx_agraph.to_agraph(G)
A.draw('example.png', prog='dot')
```

[Image: image.png]

## 2018-12-4

## 问题1

### Echarts  graph 设置箭头

参考链接：

https://github.com/apache/incubator-echarts/issues/6141
https://ecomfe.github.io/echarts-doc/public/en/option.html#series-graph.edgeSymbol

```
 edgeSymbol: [null, 'arrow'],
 edgeSymbol: ['circle', 'arrow']
```



```
 # http://gallery.echartsjs.com/editor.html?c=xB1XmPH9jb
 series: [{
        name: '招标倾向性分析',
        type: 'graph',
        layout: 'force',
        edgeSymbol: ['circle', 'arrow'],
        // label: {
        // normal: {show: true}
        // },
        edgeLabel: {
        normal: {
            textStyle: {
                fontSize: 20
            }
        }
        },
        force: {
            repulsion: 500,
            edgeLength: 120
        },
```

## 问题2

使用csv保存数据

```
import csv

data=[('smith, bob',2),('carol',3),('ted',4),('alice',5)]

with open('file.csv','wb') as out:
    csv_out=csv.writer(out)
    csv_out.writerow(['name','num'])
    for row in data:
        csv_out.writerow(row)
```

## 问题3 

使用explain方法统计一次查询所需要的执行时间

Django 2.1中QuerySet新增了explain方法，可以统计一个查询所消耗的执行时间

```
print(Blog.objects.filter(title='My Blog').explain(verbose=True))
```

## 2018-12-7

## 问题1

https://www.cnblogs.com/linxiyue/p/4060213.html

```
 user `=` User.objects.create_user(`username``=`validated_data[``'`username`'``],
                                `password``=`validated_data[``'`password`'``],
                                email`=`validated_data[``'email``'``])
```


[Image: image.png]
## 2018-12-8

## 问题1 

## django中时区问题

```
`TIME_ZONE` ：Django的时区
`TIME_ZONE = 'UTC' # 标准国际时间（格林威治时间，与中国北京时间相差8小时）`
`TIME_ZONE = 'Asia/Shanghai'`，自动转换成上海时间显示
```



```
`USE_TZ = False`时，Django会在ORM查询的结果返回时，自动转换为上海时间，不管数据库里面存的是什么时间   
```



## 问题2 

参考链接：
https://python3-cookbook.readthedocs.io/zh_CN/latest/c01/p13_sort_list_of_dicts_by_key.html
https://www.dr-chuck.com/csev-blog/2010/01/fun-python-syntax-operator-itemgetter-sorted-and-lambda-functions-oh-my/

## itemgetter在sorted中的使用

``operator.itemgetter()`` 函数有一个被 ``rows`` 中的记录用来查找值的索引参数。可以是一个字典键名称， 一个整形值或者任何能够传入一个对象的 ``__getitem__()`` 方法的值。 如果你传入多个索引参数给 ``itemgetter()`` ，它生成的 ``callable`` 对象会返回一个包含所有元素值的元组， 并且 ``sorted()`` 函数会根据这个元组中元素顺序去排序。

``itemgetter()`` 有时候也可以用 ``lambda`` 表达式代替，比如：

```
rows_by_fname = sorted(rows, key=**lambda** r: r['fname'])
rows_by_lfname = sorted(rows, key=**lambda** r: (r['lname'],r['fname']))
```


使用 ``itemgetter()`` 方式会运行的稍微快点。因此，如果你对性能要求比较高的话就使用 ``itemgetter()`` 方式。

``itemgetter()`` 有时候也可以用 ``lambda`` 表达式代替，比如：

```
>>> a = { "a": 9, "b" : 8, "c" : 7 }
>>> b = sorted(a.items())   # Sort by key
>>> b
[('a', 9), ('b', 8), ('c', 7)]
>>> >>> c = sorted(a.items(),key=lambda x: x[1])  # By value
>>> c
[('c', 7), ('b', 8), ('a', 9)]
>>> c = sorted(a.items(),key=lambda x: x[1], reverse=True)  # By Value Backwards
>>> c
[('a', 9), ('b', 8), ('c', 7)]
>>> d = sorted(a.items(),key=lambda x: (x[1], x[0]), reverse=True)  # Value then Key
>>> d
[('a', 9), ('b', 8), ('c', 7)]

```



## 问题3

## git 中打标签

参考链接：https://www.liaoxuefeng.com/wiki/0013739516305929606dd18361248578c67b8067c8c017b000/001376951758572072ce1dc172b4178b910d31bc7521ee4000

### **创建标签**

`git tag <tagname>`用于新建一个标签，默认为`HEAD`，也可以指定一个commit id；

```
$ git tag v0.9 f52c633
```

`git tag -a <tagname> -m "标签信息"`可以指定标签信息；


```
$ git tag -a v1 -m "预发布版本" 1094adb
```

### 操作标签

### 删除标签

```
` git tag -d v0.1`
```


**删除远程标签**

```
$ git tag -d v1.0  # 先删除本地标签
$ git push origin :refs/tags/v1.0 # 再删除远程标签
```

**总结**

* 命令`git push origin <tagname>`可以推送一个本地标签；
* 命令`git push origin --tags`可以推送全部未推送过的本地标签；
* 命令`git tag -d <tagname>`可以删除一个本地标签；
* 命令`git push origin :refs/tags/<tagname>`可以删除一个远程标签。

## 2018-12-12

## 问题1:

### 在pandas DataFrame中将某一列数据类型为timestamp转为字符串并修改格式

参考链接：https://stackoverflow.com/questions/35312981/using-pandas-to-datetime-with-timestamps
查询关键词参考：[Using pandas to_datetime with timestamps](https://stackoverflow.com/questions/35312981/using-pandas-to-datetime-with-timestamps)

```
datas = pd.read_excel(file_obj)
# 将pandas中解析出来的数据为Null的用None代替
datas = customs_datas.where(customs_datas.notnull(), None)
# unit
datas['日期'] = pd.to_datetime(customs_datas['日期'], unit='s').dt.strftime("%Y-%m-%d")
```

```
# 效率低写法（数据量多就gg）
for customs_datas_list in customs_datas_lists:
    customs_datas_list['日期'] = datetime.datetime.strftime(customs_datas_list['日期'], "%Y-%m-%d")
```



## 问题2

###  DataFrame to json 

（之后整理）
参考链接：https://pandas.pydata.org/pandas-docs/stable/generated/pandas.DataFrame.to_json.html

```
 # 转为字符串   秒级别 （数据量大就崩了） 
 df.to_json(orient='records')
 '[{"col 1":"a","col 2":"b"},{"col 1":"c","col 2":"d"}]'
```



## 2018-12-13

## 问题1：

### list中边遍历边删除

https://stackoverflow.com/questions/1207406/how-to-remove-items-from-a-list-while-iterating
https://stackoverflow.com/a/1208792

```
# 倒序遍历 
for i in range(len(somelist) - 1, -1, -1):
    if some_condition(somelist, i):
        del somelist[i]
```

## 2018-12-14 

## 问题1：

参考：[2018-11-20](https://hujialou.quip.com/XmkJAY4lbraa#GEBACAIsmZk)

### 按照当前日期计算下一个月的日期

```
`s  = datetime.date(2018, 12, 1)`
`>>> s `
`datetime.date(2018, 12, 1)`
`>>> from dateutil.relativedelta import relativedelta`
`>>> s + relativedelta(months=+1)`
`datetime.date(2019, 1, 1)`
```

## 2018-12-18

未整理

## 问题1:

### mac 上使用pyenv出现的问题

### pyenv global 3.6.6  不生效

参考链接：
https://github.com/pyenv/pyenv
MacOS 10.12 + zsh install issue：https://github.com/pyenv/pyenv/issues/846

https://github.com/sorin-ionescu/prezto/issues/381

mac安装时注意：
Zsh note: Modify your `~/.zshenv` file instead of `~/.bash_profile`. Ubuntu and Fedora note: Modify your `~/.bashrc` file instead of `~/.bash_profile`. Proxy note: If you use a proxy, export `http_proxy` and `HTTPS_PROXY`too.

## 问题2：

项目中安装poetry显示： zsh: not found poetry 
https://github.com/sdispater/poetry#installation


```
# 可以正常安装
curl -sSL https://raw.githubusercontent.com/sdispater/poetry/master/get-poetry.py | python

# zsh: poetry command not found 
poetry install 

```



参考链接：
**/bin/sh: poetry: not found**：https://github.com/sdispater/poetry/issues/525
**Poetry Command Not Found on zs**:https://github.com/sdispater/poetry/issues/507

### 解决方法：

Just to check: if you create a `~/.zprofile` and add `export PATH="$HOME/.poetry/bin:$PATH"` to it and then restart your shell。

## 2018-12-19 

## 问题1：

can do make a schedule for running code every month ?

参考链接：
https://github.com/dbader/schedule/issues/73
Longer time intervals：https://github.com/dbader/schedule/issues/82 
解决方法：
`every(30).days.do(...)`

存在的问题：
每当机器或者服务重启，计时器也会重置


```
# complex schedule
import datetime
import sys

# End date
end_day = 10
end_month = 3

def job():
    #  check the current date with the end date
    cur = datetime.datetime.now()
    if cur.day = end_day and cur.month == end_month:
        sys.exit()

    # otherwise, run your job
    print("hello world!")
```

## 2018-12-20

## 问题1 

pandas 测试中使用了 xlrd 
[Image: image.png][Image: image.png]
```
# 安装
poetry add xlrd 
```

## 问题2

## Auto-detecting the n+1 queries problem in Python

### 参考链接：

https://github.com/jmcarp/nplusone


## 2018-12-21

## 问题1

## postgresql dump database

### 参考链接：https://www.postgresql.org/docs/9.4/backup-dump.html

### Handling Large Databases

**Use compressed dumps.** You can use your favorite compression program, for example gzip:

```
pg_dump `dbname` | gzip > `filename`.gz
```


Reload with:

```
gunzip -c `filename`.gz | psql `dbname`
```


or:

```
cat `filename`.gz | gunzip | psql `dbname`
```


**Use** **`split`.** The `split` command allows you to split the output into smaller files that are acceptable in size to the underlying file system. For example, to make chunks of 1 megabyte:

```
pg_dump `dbname` | split -b 1m - `filename`
```


Reload with:

```
cat `filename`* | psql `dbname`
```


[Image: image.png][Image: image.png][Image: image.png]
[Image: image.png]

## 2018-12-23

## 问题1：Django 中批量创建对象 

参考链接：https://docs.djangoproject.com/en/2.1/ref/models/querysets/#bulk-create

`bulk_create`**(***objs***,** *****batch_size=None***)**[¶](https://docs.djangoproject.com/en/2.1/ref/models/querysets/#django.db.models.query.QuerySet.bulk_create)（上万条数据毫秒级别）

主要原理：利用了django的懒加载

```
from itertools import islice

batch_size = 100
objs = (Entry(headline='Test %s' % i) for i in range(1000))
while True:
    batch = list(islice(objs, batch_size))
    if not batch:
        break
    Entry.objects.bulk_create(batch, batch_size)
```

## 问题2

### 'int' object has no attribute 'encode' 

参考链接：https://stackoverflow.com/a/43321769

That's because you're passing an integer in the JSON and you don't cast it as string later while Django expects a string for the password.
So make sure you cast the password as string:

```
`password = str(request.data['password'])`
```



## 问题3

security:安全

```
django.middleware.security.SecurityMiddleware
```




## 问题4

djagno Rest Framework中针对不同的方法（list、retrieve、delete）使用不同的queryset 

关键：`self`
[Image: image.png][Image: image.png][Image: image.png]
```
class xxxxViewSet(mixins.ListModelMixin, mixins.RetrieveModelMixin, viewsets.GenericViewSet):

    def get_serializer_class(self):
        if self.action == 'list':
            return xxxxSerializer
        else:
            return xxxxDetailSerializer

    def get_queryset(self):
        if self.action == 'list':
            queryset = xxxx.objects.filter(xxx__xxxx__display="是").distinct()
        else:
            queryset = xxxx.objects.all().distinct()
        return queryset
```

## 问题5

## 关闭Django REST framework 的测试页面

参考链接：https://www.django-rest-framework.org/api-guide/renderers/

```
`REST_FRAMEWORK = {
'DEFAULT_RENDERER_CLASSES':
('rest_framework.renderers.JSONRenderer',
 'rest_framework.renderers.BrowsableAPIRenderer',
 )}`
```



```
`**REST_FRAMEWORK** = {
    'DEFAULT_RENDERER_CLASSES': (
        'rest_framework.renderers.**JSONRenderer**',
    )
}`
```



## 2018-12-24

## 问题1 

### Django REST Framework: 'BasePermissionMetaclass' object is not iterable

参考链接：https://stackoverflow.com/a/53650052

You have mistyped the comma in `DEFAULT_PERMISSION_CLASSES` value, due to which Django takes it as a string, instead of a tuple.

**Solution**:

```
`REST_FRAMEWORK =
{...'DEFAULT_PERMISSION_CLASSES': ( 'rest_framework.permissions.IsAdminUser', ),
...}`
```


[Image: image.png]
## 问题2

## 清除redis中所有的缓存

参考链接：
https://stackoverflow.com/a/6851929/10267639
http://www.redis.cn/commands/flushall.html
http://www.redis.cn/commands/flushdb.html

### flushall 

删除所有数据库里面的所有数据，注意不是当前数据库，而是所有数据库。
这个命令永远不会出现失败。
这个操作的时间复杂度是`O(N)`,N是数据库的数量。

### flushdb

删除当前数据库里面的所有数据。
这个命令永远不会出现失败。
这个操作的时间复杂度是`O(N)`,N是当前数据库的keys数量。

### in shell:

```
`redis-cli flushall`
```



## 2018-12-26

## 问题1

## JWT_EXPIRATION_DELTA 和 JWT_REFRESH_EXPIRATION_DELTA 的区别

参考链接：
https://stackoverflow.com/a/26834685/10267639
https://github.com/GetBlimp/django-rest-framework-jwt/issues/92#issuecomment-212846352


```
JWT_AUTH = {
    'JWT_ALLOW_REFRESH': True,
    'JWT_EXPIRATION_DELTA': datetime.timedelta(seconds=12),
    'JWT_REFRESH_EXPIRATION_DELTA': datetime.timedelta(days=7),
}
```

**JWT_REFRESH_EXPIRATION_DELTA**：自原始token被发布以后，多长时间范围内它以及它的子孙token可以被用来刷新以获得新的子孙token。

**原始token**：通过用户名/密码验证后获得的token（即obtain_jwt_token接口返回的token），原始token刷新后获得的token1，以及token1继续刷新获得的token2、token2再获得token3……形成了一串token链，token链的过期时间JWT_EXPIRATION_DELTA。

**然而**这串token链不能一直无限制刷新下去，直到原始token发布后的JWT_REFRESH_EXPIRATION_DELTA后，刷新操作将被终止，框架会返回HTTP 400。之后则必须向obtain_jwt_token请求来获取新的原始token。

再回到5mins + 7days的默认设置上来，客户端首先调用obtain_jwt_token进行登录操作，之后必须每隔小于5分钟就刷新一次token，才能保证不掉线。然而即使一直保持在线，上限也只有7天，7天过后必须重新登录，这才是5mins + 7days的确切含义。

## 问题2

## Django N+1 query solution

https://stackoverflow.com/questions/5422189/django-n1-query-solution
http://blog.oneapm.com/apm-tech/304.html

## **Optimizing slow Django REST Framework performance**

http://ses4j.github.io/2015/11/23/optimizing-slow-django-rest-framework-performance/

https://stackoverflow.com/questions/26593312/optimizing-database-queries-in-django-rest-framework/41287459

https://stackoverflow.com/a/41287459/10267639

****自动检测n+1推荐使用****
nplusone （https://github.com/jmcarp/nplusone）
 ****Django N+1 query solution方法参考****

1. https://stackoverflow.com/questions/5422189/django-n1-query-solution 
2. http://blog.oneapm.com/apm-tech/304.html 

****Optimizing slow Django REST Framework performance可参考****

1.  http://ses4j.github.io/2015/11/23/optimizing-slow-django-rest-framework-performance/ https://stackoverflow.com/questions/26593312/optimizing-database-queries-in-django-rest-framework/41287459
2.  https://stackoverflow.com/a/41287459/10267639 
3. https://www.dabapps.com/blog/api-performance-profiling-django-rest-framework/